# 网络监控技术方案

目前我们共有网络设备1200台，设备类型有16种:路由器、交换机、防火墙、光传输波分、负载均衡、DNS、安全设备、流量分析设备、上网行为管理、终端管理设备、NTP 服务器、DCI、TAP、网管服务器、堡垒机、专线。这16种类型的设备又包括了40多个品牌、250个设备型号。详细信息见附件1。

## 需要监控的内容

1. 基础监控
      网络设备需要监控的内容都包括设备软硬件情况、日志情况、性能情况。设备软硬件情况指cpu、内存、磁盘、连接数，上下行速度、系统负载、板卡.风扇等硬件状态，操作系统运行状态;日志情况指设备异常情况下发送的一些列日志，性能情况是指cpu使用率，流量使用率超过阀值所发出的告警。
2. 网络特定功能监控
      此外每一种类型的设备还有特殊监控需求，详细监控需求见表1.1

| 序号 | 设备类型     | 监控内容                                                     |
| ---- | ------------ | ------------------------------------------------------------ |
| 1    | 路由器       | 路由变动及路由基本配置健康情况，包括接口状态， 转态，路由表数目，宽带利用率，连接的设备的数量和类型。 |
| 2    | 交换机       | 广播风暴、，三层生成树状态、环路情况、MAC地址表容量。        |
| 3    | 防火墙       | 整机新建连接数、整机并发连接数、规则匹配数。                 |
| 4    | 光传输波分   | 光功率、信噪比、误码率                                       |
| 5    | 负载均衡     | 获取FS新建session数、并发session数。连接数，吞吐量，会话持久性，应用健康检查情况。 |
| 6    | DNS          | DNS服务状态、QPs数量、解析成功率、响应时间，                 |
| 7    | 安全设备     | WAF检测wcb端口的存活探测、sa探测卸载异常情况、攻击检测数，防护策略匹配数； |
| 8    | 流量分析设备 | 网络性能：重传、丢包、比特率、字节数、PPS等；<br />应用性能：应用响应时间、会话数量、 •连接失败、 协议分布，源目的ip等；<br />硬件性能：TCP窗口大小、TCP 0窗口次数、时延等； |
| 9    | 上网行为管理 | 相关进程是否正常启动。                                       |
| 10   | 终端安全管理 | 入网审核异常情況、域控导致业务异常。终端在线状态的情况等     |
| 11   | NTP服务器    | 当前时问、NTP相关进程 (ESD、ntpd、ntpm、 ledm 、 ledve）、未锁定卫星告警、NTP服务器末同步告警、通信故障告警 |
| 12   | DCI          | VPN通道状态，链路状态                                        |
| 13   | TAP          | 流量镜像是否正常，接入状态。                                 |
| 14   | 网管服务器   | 相关进程是否正常启动。                                       |
| 15   | 堡垒机       | 相关进程是否正常，守护程序的正常运行时长，系统时间、设备启动时长、系统软件版本、接口流量(实时流量统计）、支持最大链接数。 |
| 16   | 网络专线     | 关功率检测、信号检测、单通。                                 |

上面的设备需要请网络安全处细化安全设备的特殊需求

3. 网络智能监控
   基于AI的动态告警闯值、基于AI的动态规则库: 一是根据不同的区域区分告警闯值;二是绘制网络流量常态曲线，进行异常情况下的比对。

   - 线路和业务智能切换。

   - 网络埋点。

   - telemetry监控

   - NOA时延检测

## 主流监控方式

### (一) 监控协议

​     网络设备的监控协议包括四种ping 、snmp 、syslog 、ssh 、 netconftelemetry 。其中telemetry 技术较新2021年推出第一个版本时就获得了广泛关注，新一代网管产品都支持该技术，但是都只支持自有品牌产品，因此还未找到合适的应用场景，因此目前主流的网络监控还是依靠ping、snmp、syslog三种协议。有些监控需求无法通过ping、snmp、syslog获取，需要通过自研完成，特别是网络功能特定指标监控，和网络智能监控的一些需求。

| 序号 | 设备类型     | Ping | SNMP | SNMP Trap | Syslog | 备注           |
| ---- | ------------ | ---- | ---- | --------- | ------ | -------------- |
| 1    | 路由器       | 支持 | 支持 | 支持      | 支持   |                |
| 2    | 交换机       | 支持 | 支持 | 支持      | 支持   |                |
| 3    | 防火墙       | 支持 | 支持 | 支持      | 支持   |                |
| 4    | 光传输波分   | 支持 |      |           |        | 自带监控工具   |
| 5    | 负载均衡     | 支持 | 支持 | 支持      | 支持   |                |
| 6    | DNS          | 支持 | 支持 |           | 支持   | 需要适配OID    |
| 7    | 安全设备     | 支持 | 支持 |           | 支持   |                |
| 8    | 流量分析设备 | 支持 | x    |           | 支持   | 使用Syslog即可 |
| 9    | 上网行为管理 | 支持 | 支持 |           | 支持   |                |
| 10   | 终端安全管理 | 支持 | 支持 | /         | 支持   |                |
| 11   | NTP服务器    | 支持 | /    | 支持      | /      | 自带监控工具   |
| 12   | DCI          | 支持 | 支持 |           | 支持   |                |
| 13   | TAP          | 支持 | 支持 | 支持      | 支持   |                |
| 14   | 网管服务器   | 支持 | 支持 |           | 支持   |                |
| 15   | 堡垒机       | 支持 | 支持 | 支持      | x      | 监控平台读取   |
| 16   | 网络专线     | 支持 |      |           |        |                |

这些设备支持的定制化开发的方式。

| 序号 | 设备类型     | 南向接口 | 北向接口 | 备注                                                         |
| ---- | ------------ | -------- | -------- | ------------------------------------------------------------ |
| 1    | 路由器       |          |          |                                                              |
| 2    | 交换机       |          |          |                                                              |
| 3    | 防火墙       |          |          |                                                              |
| 4    | 光传输波分   |          | SNMP-V2  | 自带监控工具，已经跟华为Esight对接。                         |
| 5    | 负载均衡     |          |          |                                                              |
| 6    | DNS          |          |          |                                                              |
| 7    | 安全设备     |          |          |                                                              |
| 8    | 流量分析设备 |          |          | UPM、RAS目前支持190多种流量指标。<br />根据行内需求可以自由配置输出的告警<br />也支持API二次开发<br />输出采集到的流量内的各种信息<br />具体由现场需求決定。 |
| 9    | 上网行为管理 |          |          |                                                              |
| 10   | 终端安全管理 |          |          |                                                              |
| 11   | NTP服务器    | 暂无     | 暂无     | 自带监控工具                                                 |
| 12   | DCI          |          |          |                                                              |
| 13   | TAP          |          |          |                                                              |
| 14   | 网管服务器   |          |          |                                                              |
| 15   | 堡垒机       | 暂无     | 暂无     | 监控平台读取                                                 |
| 16   | 网络专线     |          |          |                                                              |

### (二) 各协议监控内容

1.基础监控所需协议

各种协议能监控的主要内容是

| 序号 | 功能         | SNMP                                                         | Syslog                                                       |
| ---- | ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1    | 设备状态指标 | 设备温度、风扇狀状态、电源状态、单板温度                     |                                                              |
| 2    | 支持接口指标 | 接口接收速率、接口发送速率、接口输入带宽利用率、接口输出带宽利用率、接口接收广播包速率、接口发送广播包速率、接口输入包丢弃率、接口输出包丢弃率 | 端口安全日志故障、接口的健康状况由异常转为正常、端口拒绝访问、发送隔离端口请求失败。 |
| 3    | IP报文统计   | 支持接收IP报文速率、转发IP报文速率、输人IP报文丢弃率、输出I报文丢弃率 |                                                              |
| 4    | 高级指标     | 接口光功率（接收光功率、发送光功率) 接口输入包错误率、接口输出包错误率、接口丢弃的输入包数、接口丢弃的输出包数、 接口接收错误包数、接口发送错误包数、接口收发速率(bits/s)、接口收发速率 (packets/s）、接口失效率、丢弃报文数目、接口接收多播包速率、接口发送多播包速率、接口包错误率、接口接收字节数、接口发送字节数、接口接收包数、接口发送包数、接口接收的末知协议包数、设备错误包数(frames)、接口错误报文数目 (packets) | 地址冲突、ADVPN缓存删除、ARP超速、在接收到 BPDU时进入err状态避免桥接环路、Loop Guard 环路防护、屏蔽接入网络中的非法的 DHICP 服务器、邻居计算节点主机与设备解除LLDP邻居关系、创建逻辑网络成功。 |
| 5    | 其他         | 查看设备详细信息，包括设备基本信息、接口信息、告警信息等<br/>1. 设备tp中显示设备标签、卫地址、位置、状态、系统名称、厂商、运行时间、最后轮询时间等。<br/>2. 设备tp中可显示性能数据：CPU、内存、不可达比例、响应时间 (E0706) | syslog解析日志规则可根据需求自行增加                         |

2.其他监控所需协议

syslog可以实现部分网络特定功能的监控。某些进程异常会触发syslog告警
netconf或者ssh方式，与设备交互抓取配置，定制化开发实现网络特定功能监控和网络智能化监控。

### (三)监控架构

根据监控方式的不同，将网络设备分为云内网络设备、云外网络设备、特殊网络设备三种。常见的监控方式也分头以下四种:

1. 第一种监控方式

第一种监控方式是指:所有网络设备通过独立的平台进行监控，将告警日志发送给统一运维监控平台进行整合，其中部分网络设备通过网络厂商自带的成熟网络监控产品进行监控，其它设备通过第三方统一网络监控平台进行监控，统一网络监控平台具备网络监控模块和服务器类型设备的监控模块，三层以下网络设备通过网络监控模块监控，上层以上特殊网络设备监控原理与服务器监控功能类似。

![image-20230605144337928](/Users/lihan/Documents/DCITS/image/image-20230605144337928.png)

2. 第二种监控方式
   第二种方式将网络设备分为三层以下网络设备和三层以上网络设备，分别采用不同的两个监控平台进行监控，再将告警信息分别发送给统一监控平台。

![image-20230605144406339](/Users/lihan/Documents/DCITS/image/image-20230605144406339.png)

3. 第三种监控方式
   第三种方式网络设备是跟服务器设备起，通过第三方统一监控平台进行监控，这种监控方式主要使用zabbizx实现服务器和网络设备的统一监控，用于巷换早期的IBM netcool，这些平台都具备网络设备监控模块和服务器监控模块。云内云外三层以下网络设备主要通过网络监控模块进行监控，特殊网络设备通过服务器监控模块进行监控。

4. 第四种监控方式
   这种监控方式通过全自研平台的方式实现，这种平台本身不具备任何网络告警的采集模块和分析模块，需要自己研发采集模块和分析模块。为了减少定制化开发的工作量，某些区域采用了成熟商用网络监控系统，通过跟已有网络监控系统对接的方式实现网络监控，例如终端网的设备，将独立的网络监控系统的消息报送给统一网络监控平台。

![image-20230605144514526](/Users/lihan/Documents/DCITS/image/image-20230605144514526.png)

四种监控方式中第一种和第三种方式较为主流，无论哪一种监控方式，都要具备扩展能力及自研能力，适应新的网络设备品牌，对成熟产品不能实现监控的功能进行定制化开发。每种监控方式的特点和优缺点对比见表2.4。
### (四)监控关联体系
一是向统一监控平台输出告警，二是进行监控的定制化开发，实现商用产品无法解决，但是实际运维工作中很重要的监控功能，三是与其它平台对接实现运维自动化，例如与事件平台、流程平台对接，实现自动建立工单，或者自动重启异常进程;与CMDB对接，或者与网络运维自动化平台对接，获取网络监控指标项、待监控设备列表等信息。

![image-20230605144547795](/Users/lihan/Documents/DCITS/image/image-20230605144547795.png)

四是与运维数据中台联动，实现网络告警数据的标准化处理，便于后续实现故障智能分析。

(四)相关建议

1. 告警信息需要持续梳理。

2. 特定功能监控和网络智能监控基于开放平台进行自主研发。

3. 优选成熟产品。成熟产品比自研成本低的，可以用成熟商用产品。详细情况见调研报告

## 我行网络监控情况

华为eight可以做为基础网络监控系统。用华为esight做三层以下网络设备的基础监控，该产品可以做到如下粒度的监控:

1. 网络拓扑和设备状态
    华为esight可以自动发现网络拓扑，并显示网络设备的状态和连接情况，帮助管理员了解网络设备的运行状态，及时发现和解决问题。
2. 网络流量和带宽利用率华为esight可以监控网络流量和带宽利用率，了解网络的使用情况，及时进行带宽调整和优化，提高网络的性能和可用性。
3. 硬件资源和性能指标华为esight可以监控服务器和存储设备的硬件资源和性能指标，如CPU使用率、内存使用率、硬盘容量等，帮助管理员了解设备的健康状况，及时进行维护和调整。
4. 告警和事件管理华为esight可以监控设备的告警和事件，及时发现和解决问题，同时也可以生成报告和趋势分析，帮助管理员进行运维决策和规划。
5. 目前使用情况已通过eight纳管了约700台网络设备。有些设备没有带外网，有些为外网设备，这些设备到网管平台网络不可达，没有监控。
目前有大量告警信息没有处理
## 后续工作安排
首先需要做好基础监控，其次是建设统一网络监控平台，做好相关信息的桥理，以及平台对接。最后是做好网络监控相关的定制化开发工作
### **(一) 基础监控**
使用华为esight主要工作:
**一是需要梳理监控流程**，确保每一台上线的网络设备、故障替换的网络设备都纳入监控。为了达到效果，需要短期或长期做一些工作。
	**短期:**需要定期巡检设备，确保设备的健康状况和监控指标的准确性。巡检内容包括设备状态、硬件资源、性能指标、配置和日志等方面，通过巡检发现问题，及时进行处理和维护，需要依赖人工全方位梳理。
	**长期:**建立资产入库管理平台，通过与资产入库平台对接，可以确保每一台上线的网络设备和故障替换设备都经过审批，制定上线更换审批流程。审批流程应该包括设备信息审核、设备配置审核、设备上线审核等环节。并自动纳入监控。这样可以提高设备的安全性和合规性，同时也可以减少手动操作和人为错误，提高运维效率和准确性。
**二是梳理并处理日常告警信息**，确保网络监控告警的精准性，关键告警有人及时处理。
但是esight不支持接收syslog信息，部分特殊网络设备也无法监控，需要通过统一网络监控平台进行监控.
### (二) 统一网络监控平台
打算采用第一种监控方式，基于第一类或者第二类平台，建设统一网络监控平台，对esight无法监控的设备进行定制化开发，例如DCI设备、syslog信息，并接受esight的告警信息，以及其它网络监控系统的告警信息，例如波分设备自带的网络监控系统、NTP设备自带的监控系统。
### (三) 定制化开发工作

1. **进行告警梳理**
针对网管现有的监控系统，可以按照以下步骤进行告警梳理
- 确定告警的分类
将所有的告警进行分类，可以按照告警级别、告警类型、告警来源等进行分类，以便在后续的分析和处理中更加清晰明了。
- 分析告警的频率和趋势
对不同分类的告警进行频率和趋势分析，确定哪些告警比较频繁、哪些告警呈现上升或下降趋势，以及哪些告警可能存在漏报或误报等问题
- 确定告警的优先级
根据告警的分类、频率和趋势等因素，确定每个告警的优先级，以便在后续的处理过程中，能够更加有针对性地进行处理。
- 优化告警通知方式根据不同告警的优先级，确定不同的告警通知方式，如短信、邮件、电话等，以便及时通知相关人员进行处理。
- 定期评估和更新
定期对告警梳理进行评估和更新，根据实际情况进行调整和优化，以确保告警处理的效率和准确性。
最终，通过对网管现有的监控系统进行告警梳理，可以帮助网络管理员更好地管理和维护网络，及时发现和解决问题，提高网络的稳定性和可靠性。
2. **向统一监控平台输出告警**
- 确定输出接口
  首先需要确定统一监控平台所提供的输出接口，如API接口、SNMP Trap、Syslog等。根据输出接口的不同，需要进行相应的配置和调整

- 配置告警输出
  根据统一监控平台提供的输出接口,进行相应的配置，将告警信息输出到指定的接口中。

- 定期进行维护和更新
  告警输出的配置和调整不是一次性的工作，需要定期进行维护和更新，根据以确保告警实际情况进以确保告警信息的准确性和及时性。
  最终，通过将告警信息输出到统一监控平台，可以将不同系统的告警信息集中管理，提高告警处理的效率和准确性，减少因漏报或误报造成的损失。
  
3. **进行监控的定制化开发**
    实现商用产品无法解决，但是实际运维工作中很重要的监控功能，首先需要明确自己的需求，包括需要监控的内容、监控的范围、监控的频率、告警的处理方式等。同时需要评估现有的商用监控产品和开源监控工具是否能够满足要求，确定是否需要进行定制化开发

4. **与其它平台对接实现运维自动化**
例如与事件平台、流程平台对接，实现自动建立工单，与CMDB对接，或者与网络运维自动化平台对接，获取网络监控指标项、待监控设备列表等信息。
- 与事件平台对接：通过与事件平台对接，将监控平台的告警信息与事件平台的事件进行关联，可以实现自动化的告警处理和事件响
	
- 与流程平台对接：通过与流程平台对接，将监控平台的告警信息与流程平台的流程进行关联,可以实现自动化的告警处理和流程执们。

- 与工单管理平台对接：工单管理平台可以用于管理运维单，如故障处理、变更管理等。通过与工单管理平台的对接，可以实现监控告警与运维工单的自动化关联，提高运维效率和准确性。

- 与网络运维自动化平台对接：获取监控指标项、待监控的设备信息等。

通过将监控平台与事件平台、流程平台、CMDB和网络运维自动化平台进行对接，可以实现运维自动化，提高运维效率和准确性，减少因人为干预造成的错误和损失。

telemetry监控作为测试。

